---
title: "capstone"
author: "KuanCheng"
date: "2024-09-29"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(foreign)
library(tidyverse)
library(ggplot2)
library("dplyr")
library("ggpubr")
library(cluster)
library(ggpubr)
library(factoextra)
```

#Collected data from each cohort of NHANES Demographic Variables, Body Measures, Medical Conditions and Smoking - Cigarette Use dataset.
#Loading the raw data files, extension is where it currently is
```{r}
demography = "DEMO_1112.XPT" # Demographic Variables
demography = read.xport(demography)

body = "body_1112.XPT" # Body Measures
body = read.xport(body)

condition = "condition_1112.XPT" # Medical Conditions
condition = read.xport(condition) 

smoke = "smoke_1112.XPT" # Smoking - Cigarette Use
smoke = read.xport(smoke)
```

#GENDER, AGE, ever smoke, started smoking, Do now smoke cigarettes, How long since quit smoking, Ever have asthma, Age first had asthma, 
#Still have asthma, Ever had emphysema, Age had emphysema, Ever had chronic bronchitis, still have chronic bronchitis
#Close relative had asthma?
```{r}
total <- merge(demography,condition,by="SEQN")
total_1 <- merge(total, smoke,by="SEQN")
total_2 <- merge(total_1, body, by="SEQN")
df_1112 <- total_2[c("SEQN","RIAGENDR", "RIDAGEYR", "SMQ020","SMD030","SMQ040","SMQ050Q", "MCQ010",
                "MCQ160G", "MCQ160K", "MCQ300B", "BMXBMI", "INDFMPIR","DMDEDUC2")]
df_1112_2 = df_1112[complete.cases( df_1112[ ,c("MCQ010", "MCQ160G", "MCQ160K")]),]
df_1112_2$BMI <- cut(df_1112_2$BMXBMI, breaks = c(0,18.5,25,30,40,100), labels = c("1","2","3","4", "5"))
```


#year 1314
```{r}
demo_1314 = "demo_1314.XPT"
demo_1314 = read.xport(demo_1314)

body_1314 = "body_1314.XPT"
body_1314 = read.xport(body_1314)

condition_1314 = "condition_1314.XPT"
condition_1314 = read.xport(condition_1314)

smoke_1314 = "smoke_1314.XPT"
smoke_1314 = read.xport(smoke_1314)

m1314_1 = merge(demo_1314, body_1314, by="SEQN")
m1314_2 = merge(m1314_1, condition_1314,by="SEQN")
m1314_3 = merge(m1314_2, smoke_1314,by="SEQN")

df_1314 = m1314_3[c("SEQN","RIAGENDR", "RIDAGEYR", "SMQ020","SMD030","SMQ040","SMQ050Q", "MCQ010",
                "MCQ160G", "MCQ160K", "MCQ300B", "BMXBMI", "INDFMPIR","DMDEDUC2")]
df_1314_2 = df_1314[complete.cases( df_1314[ ,c("MCQ010", "MCQ160G", "MCQ160K")]),]
df_1314_2$BMI <- cut(df_1314_2$BMXBMI, breaks = c(0,18.5, 25, 30, 40,100), labels = c("1","2","3","4", "5"))
```

#year 1516
```{r}
demo_1516 = "demo_1516.XPT"
demo_1516 = read.xport(demo_1516)

body_1516 = "body_1516.XPT"
body_1516 = read.xport(body_1516)

condition_1516 = "condition_1516.XPT"
condition_1516 = read.xport(condition_1516)

smoke_1516 = "smoke_1516.XPT"
smoke_1516 = read.xport(smoke_1516)

m1516_1 = merge(demo_1516, body_1516, by="SEQN")
m1516_2 = merge(m1516_1, condition_1516,by="SEQN")
m1516_3 = merge(m1516_2, smoke_1516,by="SEQN")

df_1516 = m1516_3[c("SEQN","RIAGENDR", "RIDAGEYR", "SMQ020","SMD030","SMQ040","SMQ050Q", "MCQ010",
                "MCQ160G", "MCQ160K", "MCQ300B", "BMXBMI", "INDFMPIR","DMDEDUC2")]
df_1516_2 = df_1516[complete.cases( df_1516[ ,c("MCQ010", "MCQ160G", "MCQ160K")]),]
df_1516_2$BMI <- cut(df_1516_2$BMXBMI, breaks = c(0,18.5, 25, 30, 40,100), labels = c("1","2","3","4", "5"))
```

#year 1718
```{r}
demo_1718 = "demo_1718.XPT"
demo_1718 = read.xport(demo_1718)

body_1718 = "body_1718.XPT"
body_1718 = read.xport(body_1718)

condition_1718 = "condition_1718.XPT"
condition_1718 = read.xport(condition_1718)

smoke_1718 = "smoke_1718.XPT"
smoke_1718 = read.xport(smoke_1718)

m1718_1 = merge(demo_1718, body_1718, by="SEQN")
m1718_2 = merge(m1718_1, condition_1718,by="SEQN")
m1718_3 = merge(m1718_2, smoke_1718,by="SEQN")

df_1718 = m1718_3[c("SEQN","RIAGENDR", "RIDAGEYR", "SMQ020","SMD030","SMQ040","SMQ050Q", "MCQ010",
                "MCQ160G", "MCQ160K", "MCQ300B", "BMXBMI", "INDFMPIR","DMDEDUC2")]
df_1718_2 = df_1718[complete.cases(df_1718[ ,c("MCQ010", "MCQ160G", "MCQ160K")]),]
df_1718_2$BMI <- cut(df_1718_2$BMXBMI, breaks = c(0,18.5, 25, 30, 40,100), labels = c("1","2","3","4", "5"))
```

#combine the year data
```{r}
df <- rbind(df_1314_2, df_1112_2)
df1 <- rbind(df, df_1516_2)
df2 <- rbind(df1, df_1718_2)
```

```{r}
# poverty level
df2$PLevel_ = cut(df2$INDFMPIR, breaks = c(0,1.5, 4, 6), labels = c("Low", "Medium", "High"))
df2$PLEVEL = cut(df2$INDFMPIR, breaks = c(0,1.5, 4, 6), labels = c(1, 2, 3))
# group it to Less than High School (Group 1), High School Graduate (Group 2), College Graduate (Group 3), and Postgraduate Degree (Group 4)
df2$edu_ <- factor(df2$DMDEDUC2, levels = c(1, 2, 3, 4, 5), labels = c("Under High School", "Under High School", 
                                   "High School Graduate", "College Graduate", "Postgraduate Degree"))
# disease condition
df2 <- df2 %>% mutate(is_disease = case_when(
  MCQ010 == 1 | MCQ160G == 1 | MCQ160K == 1 ~ 1,
  MCQ010 == 2 & MCQ160G == 2 & MCQ160K == 2 ~ 0
))
# smoke condition
df2 <- df2 %>% mutate(smoke_ = case_when(
  SMQ020 == 2 ~ "Never",
  SMQ040 == 3 & SMQ020 == 1 ~ "Quit",
  SMQ040 == 1 | SMQ040 == 2 ~ "Now"
))
df3 <- df2[complete.cases(df2[,c("is_disease", "RIDAGEYR", "BMXBMI", "edu_", "PLevel_", "smoke_")]),]
```
#age distribution
```{r}
# check age distribution. set 20-39, 40-59, 60-80 three groups.
summary(df2$RIDAGEYR)

# plot distribution in percentage
df2$age_group <- cut(df2$RIDAGEYR, breaks = c(20, 39, 59, 80), labels = c("20-39", "40-59", "60-80"), right = TRUE)

age_distribution <- prop.table(table(df2$age_group)) * 100
barplot(age_distribution, main = "Age Distribution", xlab = "Age Group", ylab = "Percentage (%)", ylim = c(0, 40))

```

```{r}
# we can make table like this
library(dplyr)
library(tidyr)

total_ever_disease <- df2 %>%
  filter(MCQ010 == 1 | MCQ160G == 1 | MCQ160K == 1)  # Total ever disease

non_case <- df2 %>%
  filter(MCQ010 == 2 & MCQ160G == 2 & MCQ160K == 2)  # Non-case

gender_summary <- df2 %>%
  group_by(RIAGENDR) %>%
  summarise(
    TotalEverDisease = sum(MCQ010 == 1 | MCQ160G == 1 | MCQ160K == 1, na.rm = TRUE),
    NonCase = sum(MCQ010 == 2 & MCQ160G == 2 & MCQ160K == 2, na.rm = TRUE),
    Total = n() ) %>%
  mutate(PercentageEverDisease = (TotalEverDisease / Total) * 100,
    PercentageNonCase = (NonCase / Total) * 100)

gender_summary

```

#smoke group
```{r}
smoke_summary <- df2 %>% drop_na("smoke_") %>% 
  group_by(smoke_) %>% 
  summarise(
    totalDisease = sum(is_disease == 1, na.rm = TRUE),
    NonCase = sum(is_disease == 0, na.rm = TRUE),
    Total = n()) %>%
  mutate(p_disease = totalDisease/Total*100,
    p_non = NonCase/ Total*100 )
smoke_summary
```

```{r}
# Assume df is your existing data frame
smoke_tidy <- smoke_summary %>% select("smoke_","p_disease", "p_non")
  pivot_longer(cols = -smoke_, names_to = "Status", values_to = "Count")

# View result
print(smoke_tidy)
```

```{r}
smoke_summary %>% filter(p_disease, p_non)
```



```{r}
specie <- c(rep("sorgho" , 3) , rep("poacee" , 3) , rep("banana" , 3) , rep("triticum" , 3) )
condition <- rep(c("normal" , "stress" , "Nitrogen") , 4)
value <- abs(rnorm(12 , 0 , 15))
data <- data.frame(specie,condition,value)
data
# Grouped
ggplot(data, aes(fill=condition, y=value, x=specie)) + 
    geom_bar(position="dodge", stat="identity")
```


#poverty group
```{r}
poverty_summary <- df2 %>% drop_na(PLevel_) %>% 
  group_by(PLevel_) %>% 
  summarise(
    totalDisease = sum(is_disease == 1, na.rm = TRUE),
    NonCase = sum(is_disease == 0, na.rm = TRUE),
    Total = n()) %>%
  mutate(p_disease = totalDisease/Total*100,
    p_non = NonCase/ Total*100)

poverty_summary
```

#poverty smoke group
```{r}
poverty_smoke_summary <- df2 %>% drop_na(PLevel_, smoke_) %>% 
  group_by(PLevel_, smoke_) %>% 
  summarise(
    totalDisease = sum(is_disease == 1, na.rm = TRUE),
    NonCase = sum(is_disease == 0, na.rm = TRUE),
    Total = n()) %>%
  mutate(p_disease = totalDisease/Total*100,
    p_non = NonCase/ Total*100 )

poverty_smoke_summary
```

#BMI group
```{r}
BMI_summary <- df2 %>% drop_na(BMI) %>% 
  group_by(BMI) %>% 
  summarise(
    totalDisease = sum(is_disease == 1, na.rm = TRUE),
    NonCase = sum(is_disease == 0, na.rm = TRUE),
    Total = n()) %>%
  mutate(p_disease = totalDisease/Total*100,
    p_non = NonCase/ Total*100 )

BMI_summary
```

#BMI smoke group
```{r}
BMI_smoke_summary <- df2 %>% drop_na(BMI, smoke_) %>% 
  group_by(BMI, smoke_) %>% 
  summarise(
    totalDisease = sum(is_disease == 1, na.rm = TRUE),
    NonCase = sum(is_disease == 0, na.rm = TRUE),
    Total = n()) %>%
  mutate(p_disease = totalDisease/Total*100,
    p_non = NonCase/ Total*100 )

BMI_smoke_summary
```

#edu group
```{r}
edu_summary <- df2 %>% drop_na(edu_) %>% 
  group_by(edu_) %>% 
  summarise(
    totalDisease = sum(is_disease == 1, na.rm = TRUE),
    NonCase = sum(is_disease == 0, na.rm = TRUE),
    Total = n()) %>%
  mutate(p_disease = totalDisease/Total*100,
    p_non = NonCase/ Total*100 )

edu_summary

# Add a Total row
edu_summary <- bind_rows(
  edu_summary,
  edu_summary %>%
    summarise(
      edu_ = "Total",
      totalDisease = sum(totalDisease),
      NonCase = sum(NonCase),
      Total = sum(Total),
      p_disease = totalDisease / Total * 100,
      p_non = NonCase / Total * 100
    )
)
?bind_rows
edu_summary
```



```{r}
# Extract total row values
total_disease_total <- edu_summary$totalDisease[edu_summary$edu_ == "Total"]
total_noncase_total <- edu_summary$NonCase[edu_summary$edu_ == "Total"]
total_total <- edu_summary$Total[edu_summary$edu_ == "Total"]

# Create an empty dataframe to store results
edu_predict <- data.frame(
  edu_ = edu_summary$edu_[edu_summary$edu_ != "Total"], # Exclude 'Total' row
  exp_Disease = NA,
  exp_NonCase = NA
)

# Loop through each education level (excluding "Total") and compute values
for (i in 1:(nrow(edu_summary) - 1)) {
  edu_predict$exp_Disease[i] <- total_disease_total * (edu_summary$Total[i] / total_total)
  edu_predict$exp_NonCase[i] <- total_noncase_total * (edu_summary$Total[i] / total_total)
}

# Print the final table
print(edu_predict)
```

```{r}
edu_std <- data.frame(
  edu_ = edu_predict$edu_,
  std_Disease = NA,
  std_NonCase = NA
)
 
for (i in 1:nrow(edu_predict)) {
  edu_std$std_Disease[i] <- (edu_summary$totalDisease[i] - edu_predict$exp_Disease[i])/edu_predict$exp_Disease[i]^0.5
  edu_std$std_NonCase[i] <- (edu_summary$NonCase[i] - edu_predict$exp_NonCase[i])/edu_predict$exp_NonCase[i]^0.5
}

print(edu_std)
```

#edu smoke group3
```{r}
edu_smoke_summary <- df2 %>% drop_na(edu_, smoke_) %>% 
  group_by(edu_, smoke_) %>% 
  summarise(
    totalDisease = sum(is_disease == 1, na.rm = TRUE),
    NonCase = sum(is_disease == 0, na.rm = TRUE),
    Total = n()) %>%
  mutate(p_disease = totalDisease/Total*100,
    p_non = NonCase/ Total*100 )
# Create total row for each edu_ group
edu_total <- edu_smoke_summary %>%
  group_by(edu_) %>%
  summarise(
    smoke_ = "Total",
    totalDisease = sum(totalDisease),
    NonCase = sum(NonCase),
    Total = sum(Total),
    p_disease = totalDisease / Total * 100,
    p_non = NonCase / Total * 100,
    .groups = "drop"
  )

# Combine the original summary with the total rows
edu_smoke_summary <- bind_rows(edu_smoke_summary, edu_total) %>%
  arrange(edu_, smoke_)
edu_smoke_summary
```



#2-way chi square BMI
```{r}
# create matrix with 2 columns and 5 rows
data= matrix(c(78,295,923,4990,1107,5724,1316,5210,541,1104), ncol=2, byrow=TRUE)
 
# specify the column names and row names of matrix
colnames(data) = c('Ever have respirator disease','None case')
rownames(data) <- c('Under weight','Healthy','Overweight','Obesity', 'Severe obesity')
# assign to table
BMI_dis=as.table(data)

#chi square test
chisq <- chisq.test(BMI_dis)
chisq
round(chisq$residuals,2)
alpha <- .05
alpha_adj <- alpha/(nrow(data)*ncol(data))
t_crit <- qnorm(alpha_adj/2)
```

#2-way chi square BMI group with now smoking
```{r}
data = matrix(c(38,93,290,1011,256,990,306,844,118,178), ncol = 2, byrow = TRUE)

colnames(data) = c('Ever have respirator disease','None case')
rownames(data) <- c('Under weight','Healthy','Overweight','Obesity', 'Severe obesity')

BMI_smoke= as.table(data)

#chi square test
chisq <- chisq.test(BMI_smoke)
chisq
round(chisq$residuals,2)
alpha <- .05
alpa_adj <- alpha/(nrow(data)*ncol(data))
t_crit <- qnorm(alpha_adj/2)
#cohenW(BMI_dis)
```
#2-way chi square BMI group with quit smoking
```{r}
data = matrix(c(17,33,197,890,323,1387,377,1284,156,247), ncol = 2, byrow = TRUE)
colnames(data) = c('Ever have respirator disease','None case')
rownames(data) <- c('Under weight','Healthy','Overweight','Obesity', 'Severe obesity')

BMI_quit= as.table(data)
#chi square test
chisq <- chisq.test(BMI_quit)
chisq
round(chisq$residuals,2)
alpha <- .05
alpha_adj <- alpha/(nrow(data)*ncol(data))
t_crit <- qnorm(alpha_adj/2)
```

```{r}
data = matrix(c(23,169,435,3085,527,3343,632,3076,267,679), ncol = 2, byrow = TRUE)

colnames(data) = c('Ever have respirator disease','None case')
rownames(data) <- c('Under weight','Healthy','Overweight','Obesity', 'Severe obesity')

BMI_Nsmoke= as.table(data)
#chi square test
chisq <- chisq.test(BMI_Nsmoke)
chisq
round(chisq$residuals,2)
```

#2-way chi square Poverty level
```{r}
# create matrix with 2 columns and 5 rows
data= matrix(c(1593,5675,1283,5887,760,4090), ncol=2, byrow=TRUE)
 
# specify the column names and row names of matrix
colnames(data) = c('Ever have respirator disease','None case')
rownames(data) <- c('Low','Medium','High')
# assign to table
PL_dis=as.table(data)

#chi square test
chisq <- chisq.test(PL_dis)
chisq
round(chisq$residuals,2)
alpha <- .05
alpha_adj <- alpha/(nrow(data)*ncol(data))
t_crit <- qnorm(alpha_adj/2)
t_crit
```
#2-way chi square Gender
```{r}
# create matrix with 2 columns and 5 rows
data= matrix(c(1795,8721,2321,8849), ncol=2, byrow=TRUE)
 
# specify the column names and row names of matrix
colnames(data) = c('Ever have respirator disease','None case')
rownames(data) <- c('Male','Female')
# assign to table
gen_dis=as.table(data)

#chi square test
chisq <- chisq.test(gen_dis)
chisq
round(chisq$residuals,2)
alpha <- .05
alpha_adj <- alpha/(nrow(data)*ncol(data))
t_crit <- qnorm(alpha_adj/2)
t_crit
```

#2-way chi square Education Level
```{r}
# create matrix with 2 columns and 5 rows
data= matrix(c(853,3945,922,3874,1398,5226,847,4507), ncol=2, byrow=TRUE)
 
# specify the column names and row names of matrix
colnames(data) = c('Ever have respirator disease','None case')
rownames(data) <- c('Less than High School','High School Graduate','College Graduate','Postgraduate Degree')
# assign to table
Edu_dis=as.table(data)

#chi square test
chisq <- chisq.test(Edu_dis)
chisq
round(chisq$residuals,2)
alpha <- .05
alpha_adj <- alpha/(nrow(data)*ncol(data))
t_crit <- qnorm(alpha_adj/2)
t_crit
```

#2-way chi square Smoking habit
```{r}
# create matrix with 2 columns and 5 rows
data= matrix(c(1030,3157,1087,3913,1906,10485), ncol=2, byrow=TRUE)
 
# specify the column names and row names of matrix
colnames(data) = c('Ever have respirator disease','None case')
rownames(data) <- c('Now smoking','Quit','Never smoking')
# assign to table
smoke_dis=as.table(data)

#chi square test
chisq <- chisq.test(smoke_dis)
chisq
round(chisq$residuals,2)
alpha <- .05
alpha_adj <- alpha/(nrow(data)*ncol(data))
t_crit <- qnorm(alpha_adj/2)
t_crit
```

#Gender smoking disease 3-way table 
```{r}
gender = c("male", "female")
disease = c("have", "non")
s_habit = c("now", "quit", "never")
t_table=expand.grid(disease=disease, s_habit=s_habit, gender=gender)
n = c(484,1954,570,2521,650,4245,546,1203,517,1401,1256,6240)
t_table = cbind(t_table, count=n)
t_table
temp = xtabs(count~disease+s_habit+gender, t_table)
temp
```

```{r}
Frequency=as.vector(margin.table(temp,1))
margin.table(temp,1)
margin.table(temp,1)
Frequency
CumFrequency=cumsum(Frequency)
CumFrequency
cbind(disease,Frequency=Frequency,Percentage=Frequency/sum(Frequency),CumFrequency=CumFrequency,CumPercentage=CumFrequency/sum(Frequency))
```

```{r}
Frequency=as.vector(margin.table(temp,2))
CumFrequency=cumsum(Frequency)
cbind(s_habit,Frequency=Frequency,Percentage=Frequency/sum(Frequency),CumFrequency=CumFrequency,CumPercentage=CumFrequency/sum(Frequency))
```

```{r}
Frequency=as.vector(margin.table(temp,3))
CumFrequency=cumsum(Frequency)
cbind(gender,Frequency=Frequency,Percentage=Frequency/sum(Frequency),CumFrequency=CumFrequency,CumPercentage=CumFrequency/sum(Frequency))
```

```{r}
E=array(NA,dim(temp))
for (i in 1:dim(temp)[1]) {
for (j in 1:dim(temp)[2]) {
for (k in 1:dim(temp)[3]) {
E[i,j,k]=(margin.table(temp,3)[k]*margin.table(temp,2)[j]*margin.table(temp,1))[i]/(sum(temp))^2
}}}
E
```


#BMI cleaning (df2$BMXBMI)
```{r}
summary(df2$BMXBMI)
out_BMI <- df2 %>% filter(BMXBMI > (32.9 + 1.5*(32.9-24.3)) | BMXBMI < (24.3 - 1.5*(32.9-24.3)))
valid_BMI <- df2 %>% filter(BMXBMI <= (32.9 + 1.5*(32.9-24.3)) & BMXBMI >= (24.3 - 1.5*(32.9-24.3)))
nrow(out_BMI)
nrow(valid_BMI)
length(boxplot(df2$BMXBMI)$out)

```

```{r}
boxplot(df2$RIDAGEYR)
```


#BMI disease smoking group 2-way table
```{r}
BMI_group = c("Under weight", "Healthy", "Overweight", "Obesity", "Sever obesity")
disease = c("have", "non")
s_habit = c("now", "quit", "never")

t_table=expand.grid(disease=disease, s_habit=s_habit, BMI_group=BMI_group)
n = c(38,93,290,1011,256,990,306,844,118,178,17,33,197,890,323,1378,377,1284,156,247,23,169,435,3085,527,3343,632,3076,267,679)
t_table = cbind(t_table, count=n)
t_table
temp_BMI = xtabs(count~disease+s_habit+BMI_group, t_table)
margin.table(margin.table(temp_BMI,3),1)

```

###k_means
###deal with outliers
```{r}
df_BMI_OUT <- df3[!df3$BMXBMI %in% boxplot.stats(df3$BMXBMI)$out, ]
nrow(df_BMI_OUT)
df_out <- df_BMI_OUT[!df_BMI_OUT$RIDAGEYR %in% boxplot.stats(df_BMI_OUT$RIDAGEYR)$out, ]
df_out
write.csv(df_out, "clean_df.csv", row.names = FALSE)
```

```{r}
his_BMI <- df2 %>%
  ggplot( aes(x=BMXBMI, fill=as.factor(is_disease))) +
    geom_histogram( color="#e9ecef", alpha=0.6, position = 'identity') +
    # scale_fill_discrete() +
    scale_fill_manual(values=c("#69b3a2", "#404080"),name = "Disease Condition", labels = c("Ever have", "Non case")) +
    labs(title = "BMI Overlap between Majority and Minority") +
  theme(
  panel.background = element_rect(fill = "white",
                                colour = "white",
                                size = 0.5, linetype = "solid"),
  panel.grid.major = element_line(size = 0.05, linetype = 'solid',
                                colour = "#7B7B7B"), 
  panel.grid.minor = element_line(size = 0.015, linetype = 'solid',
                                colour = "#7B7B7B"),
  legend.box.background = element_rect(color="gray10", size=0.5),
  legend.position = "top",
  legend.key = element_rect(fill = "white", colour = "gray90")
  )
his_BMI
```


```{r}
library(hrbrthemes)

his_BMI <- df_BMI_OUT %>%
  ggplot( aes(x=BMXBMI, fill=as.factor(is_disease))) +
    geom_histogram( color="#e9ecef", alpha=0.6, position = 'identity') +
    # scale_fill_discrete() + 
    scale_fill_manual(values=c("#69b3a2", "#404080"),name = "Disease Condition", labels = c("Ever have", "Non case")) +
    labs(title = "BMI Overlap between Majority and Minority") +
  theme(
  panel.background = element_rect(fill = "white",
                                colour = "white",
                                size = 0.5, linetype = "solid"),
  panel.grid.major = element_line(size = 0.05, linetype = 'solid',
                                colour = "#7B7B7B"), 
  panel.grid.minor = element_line(size = 0.015, linetype = 'solid',
                                colour = "#7B7B7B"),
  legend.box.background = element_rect(color="gray10", size=0.5),
  legend.position = "top",
  legend.key = element_rect(fill = "white", colour = "gray90")
  )
his_BMI
```

```{r}
his_age <- df_BMI_OUT %>%
  ggplot( aes(x=RIDAGEYR, fill=as.factor(is_disease))) +
    geom_histogram( color="#e9ecef", alpha=0.6, position = 'identity') +
    scale_fill_manual(values=c("#69b3a2", "#404080"),name = "Disease Condition", labels = c("Ever have", "Non case")) +
    labs(title = "Age Overlap between Majority and Minority") +
  theme(
  panel.background = element_rect(fill = "white",
                                colour = "white",
                                size = 0.5, linetype = "solid"),
  panel.grid.major = element_line(size = 0.05, linetype = 'solid',
                                colour = "#7B7B7B"), 
  panel.grid.minor = element_line(size = 0.015, linetype = 'solid',
                                colour = "#7B7B7B"),
  legend.box.background = element_rect(color="gray10", size=0.5),
  legend.position = "top",
  legend.key = element_rect(fill = "white", colour = "gray90")
  )
his_age
ggsave("age historgram.jpg", his_age)
```



###prepare k-means
```{r}
df_out$is_disease <- factor(df_out$is_disease)
df_maj <- df_out %>% filter(is_disease == "0") 
df_min <- df_out %>% filter(is_disease == "1")
nrow(df_maj)
nrow(df_min)
df_maj$sc_age <- scale(df_maj$RIDAGEYR)
df_maj$sc_BMI <- scale(df_maj$BMXBMI)
df_maj_km <- df_maj %>% select(sc_age, sc_BMI)

```

###train test split
```{r}
#major data 
#split data
df_maj.spilt <- sample(1:nrow(df_maj_km),size = ceiling(0.80*nrow(df_maj_km)),replace = FALSE)
# training set
df_maj.train <- df_maj_km[df_maj.spilt,]
# test set
df_maj.test <- df_maj_km[-df_maj.spilt,]
nrow(df_maj.train)
nrow(df_maj.test)
#minor data
#split data
df_min.spilt <- sample(1:nrow(df_min_km),size = ceiling(0.80*nrow(df_min_km)),replace = FALSE)
# training set
df_min.train <- df_min_km[df_min.spilt,]
# test set
df_min.test <- df_min_km[-df_min.spilt,]
nrow(df_min.train)
nrow(df_min.test)
```


###apply k-means
```{r}
set.seed(123)
# Compute k-means with k = 2 - major data
km_maj <- kmeans(df_maj.train, 2, nstart = 25)

aggregate(df_maj.train, by=list(cluster=km_maj$cluster), mean)
km_maj$size

# Compute k-means with k = 2 - major data
km_min <- kmeans(df_min.train, 2, nstart = 25)
print(km_min)
aggregate(df_min.train, by=list(cluster=km_min$cluster), mean)
km_min$size
```


```{r}
fviz_cluster(km_maj, data = df_maj.train,
             palette = c("#2E9FDF", "#E7B800"), 
             geom = "point",
             ellipse.type = "convex", 
             ggtheme = theme_bw()
             )
```

### Compute silhouette score of the major clusters
```{r}
silhouette_scores <- silhouette(km_maj$cluster, dist(df_maj.train))
maj_silhouette_scores <- as.data.frame(silhouette_scores)
maj_c1 <- maj_silhouette_scores[maj_silhouette_scores$cluster == 1, ]
maj_c2 <- maj_silhouette_scores[maj_silhouette_scores$cluster == 2, ]
avg_c1 <- mean(maj_c1[, 3])
avg_c2 <- mean(maj_c2[, 3])
#choose the cluster with the higher silhouette score  
avg_c1
avg_c2
```
###apply k-means on major group cluster 1
```{r}
# Compute k-means with k = 2 - major data cluster 1
df_maj_c1 <- df_maj.train[km_maj$cluster == 1, ]
km_maj_c1 <- kmeans(df_maj_c1, 2, nstart = 25)
km_maj_c1$size
```

```{r}
fviz_cluster(km_maj_c1, data = df_maj_c1,
             palette = c("#2E9FDF", "#E7B800"), 
             geom = "point",
             ellipse.type = "convex", 
             ggtheme = theme_bw()
             )
```

### Compute silhouette score of the major cluster1's cluster
```{r}
s_scores <- silhouette(km_maj_c1$cluster, dist(df_maj_c1))
maj_s_score_c1 <- as.data.frame(s_scores)
maj_c11 <- maj_s_score_c1[maj_s_score_c1$cluster == 1,]
maj_c12 <- maj_s_score_c1[maj_s_score_c1$cluster == 2,]
avg_c11 <- mean(maj_c11[,3])
avg_c12 <- mean(maj_c12[,3])
avg_c11
avg_c12
```

###extract the major train data we want to combine with minor train data
```{r}
maj.train.final <- df_maj_c1[km_maj_c1$cluster == 2, ]
```

###combine major train and minor train data as our logistic regression training dataframe
```{r}
index_reg <- rbind(maj.train.final, df_min.train)
index_reg$seq <- as.numeric(rownames(index_reg))
df_reg <- df2[rownames(df2) %in% index_reg$seq, ]
write.csv(df_reg, "logistic train df.csv", row.names = FALSE)
```



#logistic regression 
```{r}
log <- glm(is_disease ~ smoke_ + RIAGENDR + RIDAGEYR + BMXBMI + PLevel_ + edu_, family = "binomial", data = df_reg)

summary(log)
```

```{r}
df3.test$pre_disease <- predict(log, newdata = df3.test, type = "response")
df3.test$pre_disease
```

```{r}
df3.test[,c("is_disease", "RIDAGEYR", "RIAGENDR", "BMXBMI","PLevel_","edu_", "smoke_", "pre_disease")]
df3.test <- df3.test %>% mutate(pre_is_dis = ifelse(pre_disease > 0.5, 1, 0)) %>% mutate(correct = ifelse(pre_is_dis == is_disease, 1,0))


reg_TP <- nrow(df3.test[df3.test$is_disease == 1 & df3.test$pre_is_dis == 1,] )
reg_TN  <- nrow(df3.test[df3.test$is_disease == 0 & df3.test$pre_is_dis == 0,] )
reg_FN <- nrow(df3.test[df3.test$is_disease == 1 & df3.test$pre_is_dis == 0,] )
reg_FP <- nrow(df3.test[df3.test$is_disease == 0 & df3.test$pre_is_dis == 1,] )

reg_recall <- round(reg_TP/(reg_TP+reg_FN),2)
reg_precision <- round(reg_TP/(reg_TP+reg_FP),2)
reg_specificity <- round(reg_FP/(reg_FN+reg_FP),2)
reg_F1 <- round(2*reg_precision*reg_recall/(reg_precision+reg_recall),2)
#G-mean = (Sensitivity × Specificity)1/2, sensitivity: TP rate, specificity: TN rate
reg_G_means <- round((reg_precision*reg_specificity)^0.5,2)
reg_TP
reg_FP
reg_TN
reg_FN
```

```{r}
table(df2["RIAGENDR", "is_disease"])
table(df2[""])
```

